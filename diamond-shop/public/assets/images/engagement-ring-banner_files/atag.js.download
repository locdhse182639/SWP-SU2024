(function(w,d,undefined){let r=window["ADBROTagObject"]||"atag",q=(window[r]||{})["q"]||[],config={endpoint:"https://apis.adbro.me/api/",wsendpoint:"wss://apis.adbro.me/api/"};window[r]=function(){q.push(arguments);CommandsProcessor.process()};const DEBUG__PANEL_SCRIPT="//tag.adbro.me/tags/atag.panel.js",DEBUG__FLAG="adbro_debug=true";const USER__STORAGE_KEY="adbro-uid",USER__HASH_KEY="aclid";let CommandsProcessor={process:function(){while(true){let args=q.shift();if(args===undefined)break;let command=args[0];switch(command){case"config":this._config.code(args);break;case"send":let type=args[1];this._send[type](args);break}}},_config:{code:function(args){config["code"]=args[1]}},_send:{EVENT_TYPES:{CONVERSION:4,PAGEVIEW:6,NONBOUNCE_PAGEVIEW:7},conversion:function(args){let props=args.length>2?args[2]:{},urlParams={};urlParams.eventUrl=this._getEventUrl(props);this._loadPixel(this._buildUrl(this.EVENT_TYPES.CONVERSION,urlParams));CommandsProcessor.logger.log("Conversion")},pageview:function(args){const NONBOUNCE_TIMEOUT_SECONDS=15,NONBOUNCE_TIMEOUT=NONBOUNCE_TIMEOUT_SECONDS*1e3,NONBOUNCE_PIXELS=500;let props=args.length>2?args[2]:{},urlParams={},eventDescription="";if(props.retargeting){urlParams.retargeting=1;eventDescription="Retargeting Enabled"}urlParams.eventUrl=this._getEventUrl(props);if("WebSocket"in window){const SOCKET_PING_INTERVAL=30*1e3;let socket=new WebSocket(this._buildUrl(this.EVENT_TYPES.PAGEVIEW,urlParams,"ws"));CommandsProcessor.logger.log("Page View",eventDescription);socket.addEventListener("open",function(){let socketTimer=null;socketTimer=setInterval(function(){if(socket.readyState!==socket.OPEN){clearInterval(socketTimer)}else{socket.send("")}},SOCKET_PING_INTERVAL)})}else{this._loadPixel(this._buildUrl(this.EVENT_TYPES.PAGEVIEW,urlParams));CommandsProcessor.logger.log("Page View",eventDescription)}let nonbouncePageviewSent=false;let th=CommandsProcessor._send;setTimeout(function(){if(nonbouncePageviewSent)return;th._loadPixel(th._buildUrl(th.EVENT_TYPES.NONBOUNCE_PAGEVIEW,{eventUrl:urlParams.eventUrl}));CommandsProcessor.logger.log("Marketing Visit",NONBOUNCE_TIMEOUT_SECONDS+" seconds on Page");nonbouncePageviewSent=true},NONBOUNCE_TIMEOUT);w.addEventListener("scroll",function(e){if(nonbouncePageviewSent)return;if(w.pageYOffset>NONBOUNCE_PIXELS){th._loadPixel(th._buildUrl(th.EVENT_TYPES.NONBOUNCE_PAGEVIEW,{eventUrl:urlParams.eventUrl}));CommandsProcessor.logger.log("Marketing Visit","Scrolling "+NONBOUNCE_PIXELS+" pixels");nonbouncePageviewSent=true}});d.addEventListener("click",function(e){if(nonbouncePageviewSent)return;if(th._findParent(e.target,"a")){th._loadPixel(th._buildUrl(th.EVENT_TYPES.NONBOUNCE_PAGEVIEW,{eventUrl:urlParams.eventUrl}));CommandsProcessor.logger.log("Marketing Visit","Link Click");nonbouncePageviewSent=true}})},_buildUrl:function(type,params,protocol){if(!config.code)throw"Tracking code is not configured. "+"Call atag('config', '...') before atag('send', '...')";let urlParams=params||{};let userGuid=CommandsProcessor.user.getGuid();if(userGuid)urlParams["uid"]=userGuid;return(protocol==="ws"?config.wsendpoint:config.endpoint)+"v2/advertising/track/?code="+encodeURIComponent(config.code)+"&event="+type+Object.entries(urlParams).map(function(item){return"&"+item[0]+"="+encodeURIComponent(item[1])}).join("")},_loadPixel:function(url){let img=d.createElement("img");img.src=url;img.width=1;img.height=1;if(d.body==null){d.addEventListener("DOMContentLoaded",function(){d.body.appendChild(img)})}else{d.body.appendChild(img)}},_getEventUrl:function(params){return params.eventUrl||params.pageUrl||w.location.href},_findParent:function(el,tagname){while(el){if((el.nodeName||el.tagName).toLowerCase()===tagname.toLowerCase()){return el}el=el.parentNode}return null}},user:{getGuid:function(){return localStorage.getItem(USER__STORAGE_KEY)},saveFromUri:function(){let regex=new RegExp(USER__HASH_KEY+"=([0-9a-fA-F-]{36})&?"),match=w.location.hash.match(regex);if(!match)return;localStorage.setItem(USER__STORAGE_KEY,match[1]);let newHash=w.location.hash.replace(regex,"");history.replaceState(null,null,w.location.href.split("#")[0]+(newHash!=="#"?newHash:""))}},logger:{log:function(event,description){let logger=window[r+"_logger"]||console.log;logger(event,description,config)},isDebug:function(){if(w.location.hash.indexOf(DEBUG__FLAG)>-1){document.cookie=DEBUG__FLAG+";path=/"}return document.cookie.indexOf(DEBUG__FLAG)>-1},loadDebugPanel:function(callback){let script=document.createElement("script");script.async=true;script.src=DEBUG__PANEL_SCRIPT;script.onload=callback;document.body.appendChild(script)}}};CommandsProcessor.user.saveFromUri();if(CommandsProcessor.logger.isDebug()){CommandsProcessor.logger.loadDebugPanel(function(){setTimeout(function(){CommandsProcessor.process()},100)})}else{CommandsProcessor.process()}})(window.top,window.top.document);